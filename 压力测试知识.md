## 压力测试

- 为什么要有这个

  - 风险前置
  - 计算流量压力，验证业务性能稳定性
  - 容量规划，控制预算成本
  - 熔断，降级，限流，禁流

- 关键问题

  - 流量构造，建立有意义的测试数据，不能在压测的时候能容忍千万并发，实际的时候却上万就崩溃了
  - 无损隔离：对系统进行线上压力测试的时候，不能影响实际业务，压测数据和实际数据隔离

- 压测设计

  - 流量构造：读写请求分而治之
    - 读请求回放
    - 写请求在回放的时候构造
  - 无损隔离：
    - id偏移：防止压测用的是真实用户id
    - 流量染色：让系统能够识别压测数据，减少一些额外逻辑
    - 影子存储：物理共享，逻辑隔离

- 实施

  - 压测前
    - 数据构造
    - 压测目标
    - 确定影响范围
  - 压测中
  - 压测后

- 压测前准备

  - 单机：直接禁用单机流量
  - 集群：选择业务低谷时间段
  - RPC请求
    - 实时录制
  - http请求
    - nginx日志

- 流量提升模拟

- 故障模拟

  - 超时异常模拟
  - 长耗时异常模拟
  - 熔断阈值

- 观察系统指标

- 导致系统压力原因：

  - 不是单例模式创建对象
  - 序列化开销
  - 异常打印需要竞争锁，造成开销
  - 线程池队列无限大，在高并发状况下，下游会被压垮（）
  - 线程池资源竞争

  



## 泳道设计

- 泳道是干什么的
  - 隔离测试数据
  - 线下共享测试环境
  - 方法的并行单独测试，不能因为前面的功能收到影响，自己的测试就要排队
- 泳道结构
  - 骨干链路：绝对稳定的版本
  - 泳道隔离：除了骨干，各个泳道都是快照版本
  - 泳道回流：每个泳道不需要依赖所有上下游功能，缺少的功能从骨干中寻找

![image-20200622104813189](/Users/wangkai/Library/Application Support/typora-user-images/image-20200622104813189.png)





- 泳道回收
  - 容器资源足够：7天内没有部署行为，机器会被回收
  - 容器资源不足：3天内强制回收
- 泳道路由
  - http请求：将泳道id加入到请求头
  - rpc请求：将泳道id



- 