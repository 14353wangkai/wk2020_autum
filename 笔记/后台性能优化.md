## 后台性能优化

- 性能问题没有银弹（技巧）

- 高可用
- 高性能

## 什么是性能

- 用户体验：加载慢于5s将会流失74%
- 研发成本

- TP99：第99%个用户的响应时间，如100个用户请求，第99个用户返回请求的时间



## 性能火焰图

- 性能和火焰图中的颜色没有什么关系
- x轴：抽样数（占用时间）
- y轴：调用栈（方法）

## 性能火焰图分析

- 看相邻上层方法与当前方法的宽度差
- 越下面的方法越是外层调用



## 常见问题

- 业务代码问题
  - 粗糙实现
    - 获取少量信息，却使用大量查询
    - 更改少量数据，导致大范围更新
    - 没有前后依赖，却使用串行
    - 日志记录随意，大量无用log的记录
  - 算法不当
  - 工具不当
  - 代码bug

- 外部依赖
  - 依赖资源瓶颈
    - 下游瓶颈
    - 数据库单表数据大
    - 数据库达到qps极限
    - redis节点配置不足
  - 负载不均衡
  - 跨地域
- 基础组件
  -  zebra连接池：lazy-init导致初次请求性能差
  - 连接池
  - 线程池滥用

- 串行改并行

  - 没有任何逻辑依赖关系的两个方法可以不等待前者的返回值到达再调用，对应RPC的future模式
  - 后者对前者的返回值没有依赖，并且可以容忍前者没有返回值的错误，对应one way模式 

- 性能瓶颈

  - 服务器处理性能不足的时候，服务器是瓶颈
  - 服务器处理性能足够的时候，数据库是瓶颈

- 故障处理

  ![image-20200623120303103](/Users/wangkai/Library/Application Support/typora-user-images/image-20200623120303103.png)

  - 降级处理

    - 人工处理
    - 在服务器资源不足的时候，不调用某些非核心服务

  - 熔断处理

    - 故障场景下的自我保护（名次来自电路中的保险丝）

    - 熔断器（自动处理）：自动探测某个服务器是否正常，当调用改某服务的时候出现大量错误，责判断改服务出现了故障，此时切断调用，此后自动探测这个服务器，当出现服务正常的时候，重新进行调用

    - 不采用熔断的后果

      ![image-20200623120756114](/Users/wangkai/Library/Application Support/typora-user-images/image-20200623120756114.png)

  - 限流处理

    - 漏桶？
    - 令牌桶？
    - 来源计数器

    